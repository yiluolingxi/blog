name: deploy
on:
  workflow_dispatch: # 允许手动触发
  push:
    branches: [main]
  pull_request:
    branches: [main]
    

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # 安装依赖
  install:
    runs-on: ubuntu-latest # 指定环境
    steps: #执行步骤
      # 拉取当前分支代码
      - uses: actions/checkout@v2.4.2
      
      # 安装 Node
      - name: Setup Node
        uses: actions/setup-node@v3.4.1
        with:
          node-version: 16.x
      
      # 读取缓存
      - name: Cache Node Modules
        id: cache-node-modules # 当前步骤的唯一标记，用于后续判断缓存是否命中
        uses: actions/cache@v3.0.8
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('yarn.lock') }}
          restore-keys: node-modules-
          
      # 未命中缓存，安装依赖   
      - name: Install Dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: yarn
        
  # 打包
  build:
    runs-on: ubuntu-latest # 指定环境
    needs: [install] # 前置任务
    steps: #执行步骤
      - uses: actions/checkout@v2.4.2
      - name: Setup Node
        uses: actions/setup-node@v3.4.1
        with:
          node-version: 16.x
          
      # 读取缓存
      - name: Cache Node Modules
        id: cache-node-modules # 当前步骤的唯一标记，用于后续判断缓存是否命中
        uses: actions/cache@v3.0.8
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('yarn.lock') }}
          restore-keys: node-modules-
      
      # 打包
      - name: Build Dependencies
        run: yarn build
       
      # 上传用于 Github Page 发布
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: public/blog/
      
  
  # 发布到github page
  github-deploy:
    needs: [build]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1

      
      
      
  # 发布到华为云服务器
  huaweiCloud-deploy:
    # 前提打包完成
    needs: [build]
    runs-on: ubuntu-latest
    
    steps:
    # 下载打包后文件
    - name: Download a Build Artifact
      uses: actions/download-artifact@v3.0.0
      with:
        # 唯一标志
        name: github-pages # actions/upload-pages-artifact 是利用 upload-artifact 上传到 github-pages 标志，文件名为 artifact.tar
        # 下载至文件夹
        path: '' 
    
    # 此时还是压缩包，可以上传后解压
    - name: Check Build
      run: ls -lah
        
    # 可以使用 rsync，但还是不推荐直连，后续改掉
    - name: send files to a remote server with scp
      uses: appleboy/scp-action@master
      continue-on-error: true
      with:
        host: ${{ secrets.HUAWEI_IP }}
        username: ${{ secrets.HUAWEI_USER_NAME }}
        password: ${{ secrets.HUAWEI_ACCESS_KEY_SECRET }}
        source: './*'
        target: ../var/www/blog
        # 失败重试 3 次
        retry-attempts: 3
 
