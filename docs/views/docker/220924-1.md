---
title: docker - 16 | CI Preview
date: 2022-09-24
tags:
 - docker
categories: 
 - docker
---
 



## 总结
1. 




<!-- ## 疑问
- [ ]  -->




## 提问
- [ ] 





## 1. 前提提要、场景
以前老旧的开发流程，所有人的代码都合并到统一分支，进行打包测试环境，共用一个测试环境地址。一旦有错误代码提交，例如登录页无法登录，将会影响所有测试。      

CI Preview，每一个功能分支都配有对应的测试环境，相互独立，便于测试人员进行验证。

项目研发的从开发到上线，一般可以可以划分为三个环境
1. local：本地环境，面向开发者。把项目 git clone 到自己的工作笔记本或者开发机中，在 `localhost:8080` 类似的地址进行调试与开发。
2. dev：测试环境，面向测试人员。开发者本地业务迭代开发结束并交付给测试进行功能测试的环境，在 `dev.demo.com` 类似的二级域名进行测试。
3. prod：生产环境，面向用户。线上供用户使用的环境，在 `demo.com` 类似的地址。

本次将会实现每个 feature 分支都会有一个环境，一个特殊的测试环境。如对功能 feature-A 的开发在 `feature-A.dev.demo.com` 进行测试。




## 2. 基于 docker/compose 进行部署
使用 docker 和 traefik 进行部署，部署在域名 `dev.demo.com`        
`docker-compose.yaml` 如下
```yml
version: "3"
services:
  domain:
    build:
      context: .
      dockerfile: router.Dockerfile
    labels:
      # 为 demo 配置我们的自定义域名
      - "traefik.http.routers.dev.rule=Host(`dev.demo.com`)"
      - traefik.http.routers.dev.tls=true
      - traefik.http.routers.dev.tls.certresolver=le

networks:
  default:
    external:
      name: traefik_default
```
要实现每个分支都有自己的测试环境，docker-compose 的解决方案:
1. 每个分支都要有自己的 service，根据分支名配置
2. 每个 service 都要有自己的 labels，用于 traefik 动态创建路由，根据分支名配置

开发流程中，基本都是通过 PR 合并功能分支。在 CI 构建服务器中，可通过环境变量获取到触发工作流的分支名称（GitHub Action 的 `GITHUB_HEAD_REF`），我们可以基于分支名称进行功能分支环境部署。

假设 `COMMIT_REF_NAME` 为功能分支名称的环境变量
```yml
version: "3"
services:
  dev-preview-${COMMIT_REF_NAME}:
    build:
      context: .
      dockerfile: router.Dockerfile
    labels:
      - traefik.http.routers.dev-preview-${COMMIT_REF_NAME}.rule=Host(`${COMMIT_REF_NAME}.dev.demo.com`)
      - traefik.http.routers.dev-preview-${COMMIT_REF_NAME}.tls=true
      - traefik.http.routers.dev-preview-${COMMIT_REF_NAME}.tls.certresolver=le

networks:
  default:
    external:
      name: traefik_default
```

大功告成，但还有一点问题: 在 `Service Name` 上无法使用环境变量。       





## 3. docker/compose 在 Service Name 使用环境变量
为了解决在 `Service Name` 上无法使用环境变量的问题。       
我们可以写一段脚本将文件中的环境变量进行替换，但更好的方式是通过内置于操作系统的命令 `envsubst` （专职于文件内容的环境变量替换）

> PS: 如果系统中无自带 `envsubst` 命令，可使用[第三方 envsubst](https://github.com/a8m/envsubst) 进行替代。

以下命令中的 `COMMIT_REF_NAME` 环境变量为当前分支名称，在此处可通过 `git` 命令获取。       
而在 CI 当中，可直接通过 CI 相关环境变量获得，无需通过 `git` 命令。

```bash
# envsubst 可以直接指定输入文件，默认使用环境变量，但也可以指定临时全局变量
$ COMMIT_REF_NAME=$(git rev-parse --abbrev-ref HEAD) envsubst < docker-compose.yaml

version: "3"
services:
  dev-preview-main:
    build:
      context: .
      dockerfile: router.Dockerfile
    labels:
      - traefik.http.routers.dev-preview-main.rule=Host(`main.dev.demo.com`)
      - traefik.http.routers.dev-preview-main.tls=true
      - traefik.http.routers.dev-preview-main.tls.certresolver=le

networks:
  default:
    external:
      name: traefik_default

# envsubst 可以直接指定输入输出文件
# 将代理文件进行环境变量替换后输出为 temp.docker-compose.yaml 配置文件
$ COMMIT_REF_NAME=$(git rev-parse --abbrev-ref HEAD) envsubst < docker-compose.yaml > temp.docker-compose.yaml

# 根据配置文件启动容器服务
$ docker-compose -f temp.docker-compose.yaml up --build
```



## 4. Environtment
Environtment，可以理解为环境地址。我们希望可以看到在 PR 的评论或者其它地方可以看到我们的部署地址。
- [Github Actions: environment](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idenvironment)
- [Using environments for deployment](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment)

在 CI 中配置 `environment` 为期望的部署地址，则可以在每次部署成功后，便可以看到其地址。

```yaml
environment:
  name: review/$COMMIT_REF_NAME
  url: http://$COMMIT_REF_NAME.cra.shanyue.tech
```




<!-- ## 遗留 -->





个人github：[**https://github.com/zhengjiabo**](https://github.com/zhengjiabo) 