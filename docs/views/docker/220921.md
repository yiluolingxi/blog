---
title: docker - 14 | CI 缓存
date: 2022-09-21
tags:
 - docker
categories: 
 - docker
---
 



## 总结
- 
- 



## 疑问







## 提问
- [x] 
- [ ] 







  
## 1. 前提提要、场景
在本地环境中，安装依赖时都会利用缓存，例如
1. 当使用 `npm i` 进行依赖安装时，由于 node_modules 目录已存在，将只会安装最新添加的依赖。
2. 当使用 webpack 5 进行构建时，如果使用了 `filesystem cache`，因为在磁盘中含有缓存 (node_modules/.cache)，二次构建往往比一次构建快速十几倍。

而在 CICD 中，这些都失去了意义，因为 CICD 每次 Job 都相当于新建了一个目录，每次构建都相当于是首次构建。但是，CI 提供了一些缓存机制，可以将一些资源进行缓存。如果每次可以将缓存取出来，则大大加速了前端部署的速度。     

![](./220921/1.png)
- 安装依赖-使用缓存
- 打包缓存
- 容器资源挂载
  
利用缓存的目的：减少 CICD 时间。      

## 2. 无缓存安装依赖/打包
如果不进行任何缓存上的优化，对应 `Github Actions` 
```yaml
name: Build
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Install Dependencies
        run: yarn
      - name: Build Dependencies
        run: npm run build
```
![](./220921/2.png)
可以看到无缓存安装依赖/打包的时间，要比有缓存长很多。

> 第一次执行可能有缓存的会比无缓存耗时长，因为第一次都是无缓存资源，而有缓存的 job 还要去尝试获取缓存，获取也需要时间。



## 3. 缓存配置
对 `node_modules` 进行缓存有以下两个好处
1. 没有新的 package 需要安装，无需再次 `npm i/yarn`
2. 有新的 package 需要安装，仅仅安装变动的 package

在 `Github Actions` 中，通过 [Cache Action](https://github.com/actions/cache)
- path：指需要缓存的目录
- key：根据 key 进行缓存，如果存在相同的 key，则为命中 (hit)。在 `Github Actions` 中可利用函数 `hashFiles` 针对文件计算其 hash 值。
- restore-keys：如果 ke 未命中，则使用 restore-keys 命中缓存。

输出
- cache-hit：是否命中缓存，布尔值

[Cache Examples](https://github.com/actions/cache/blob/main/examples.md#node---npm)


### 3.1 缓存依赖
```yaml
- name: Cache Node Modules
  id: cache-node-modules
  # 使用 cache action 进行目录资源缓存
  uses: actions/cache@v2
  with:
    # 对 node_modules 目录进行缓存
    path: node_modules
    # 根据字段 node-modules- 与 yarn.lock 的 hash 值作为 key
    # 当 yarn.lock 内容未发生更改时，key 将不会更改，则命中缓存
    # 如果使用 npm 作为包管理工具，则是 package-lock.json
    key: node-modules-${{ hashFiles('yarn.lock') }}
    restore-keys: node-modules- # 项目没有 yarn.lock 情况下使用该备用字段
```

缓存 `node_modules` 有时会存在问题，比如使用 `npm ci` 命令，在安装依赖之前特意将 `node_modules` 删除以保障安全性。          
如果不想缓存 `node_modules`，可以缓存 npm/yarn 全局缓存目录。通过以下命令可知他们的全局缓存目录
- npm: `npm config get cache`，如 ~/.npm
- yarn: `yarn cache dir`





### 3.2 缓存验证





## 遗留
- [ ] 什么情况下，缓存 node_modules 会发生问题。




个人github：[**https://github.com/zhengjiabo**](https://github.com/zhengjiabo) 